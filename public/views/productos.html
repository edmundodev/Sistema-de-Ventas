<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body class="bg-gradient-to-br from-pink-50 to-purple-50">
    <!-- Navbar superior -->
    <nav class="bg-gradient-to-r from-pink-500 to-purple-500 text-white py-4 px-6 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">VentasPRO</h1>
            <div class="flex items-center space-x-6">
                <a href="#" class="hover:text-pink-200 transition-colors"><i class="fas fa-box mr-2"></i>Productos</a>
                <a href="#" class="hover:text-pink-200 transition-colors"><i class="fas fa-users mr-2"></i>Usuarios</a>
                <a href="Reportes.html" class="hover:text-pink-200 transition-colors"><i class="fas fa-chart-bar mr-2"></i>Reportes</a>
                <a href="#" class="hover:text-pink-200 transition-colors"><i class="fas fa-cog mr-2"></i>Ajustes</a>
                <button onclick="logout()" class="text-red-300 hover:text-red-100 transition-colors"><i class="fas fa-sign-out-alt mr-2"></i>Cerrar sesión</button>
            </div>
        </div>
    </nav>

    <!-- Contenido principal -->
    <main class="p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Encabezado -->
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-pink-900">Productos</h1>
                <button id="openModal" class="flex items-center gap-3 bg-gradient-to-r from-pink-500 to-purple-500 text-white px-6 py-3 rounded-xl hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                    <i class="fas fa-plus"></i>
                    <span>Agregar Producto</span>
                </button>
            </div>

            <!-- Barra de búsqueda moderna -->
            <div class="mb-8">
                <div class="relative">
                    <input type="text" placeholder="Buscar productos..." class="w-full px-6 py-4 pl-14 rounded-xl bg-white shadow-sm border-2 border-pink-100 focus:border-pink-300 focus:ring focus:ring-pink-200 focus:ring-opacity-50 transition-all">
                    <i class="fas fa-search absolute left-5 top-5 text-pink-400"></i>
                </div>
            </div>

            <!-- Tabla moderna -->
            <div class="bg-white rounded-xl shadow-sm border border-pink-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gradient-to-r from-pink-50 to-purple-50">
                                <th class="px-6 py-4 text-left text-sm font-semibold text-pink-900">ID</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-pink-900">Producto</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-pink-900">Descripción</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-pink-900">Precio</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-pink-900">Stock</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-pink-900">Categoría</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-pink-900">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productos" class="divide-y divide-pink-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- Modales con tonos rosados -->
            <div id="myModal" class="fixed inset-0 bg-indigo-900 bg-opacity-40 backdrop-blur-sm flex justify-center items-center hidden z-50">
                <div class="bg-white p-8 rounded-2xl w-full max-w-md mx-4 shadow-xl">
                    <h2 class="text-2xl font-bold text-indigo-900 mb-6">Nuevo Producto</h2>
                    <form class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-indigo-900 mb-2">Nombre</label>
                            <input type="text" id="productName" class="w-full px-4 py-3 rounded-xl border-2 border-indigo-100 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Nombre del producto">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-indigo-900 mb-2">Descripción</label>
                            <input type="text" id="descripcionProduct" class="w-full px-4 py-3 rounded-xl border-2 border-indigo-100 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Descripción del producto">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-indigo-900 mb-2">Precio</label>
                            <input type="text" id="productPrice" class="w-full px-4 py-3 rounded-xl border-2 border-indigo-100 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Precio">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-indigo-900 mb-2">Stock</label>
                            <input type="text" id="productStock" class="w-full px-4 py-3 rounded-xl border-2 border-indigo-100 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Stock disponible">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-indigo-900 mb-2">Categoría</label>
                            <input type="text" id="CategoriaProduct" class="w-full px-4 py-3 rounded-xl border-2 border-indigo-100 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Categoría">
                        </div>
                        <div class="flex justify-end gap-4 mt-8">
                            <button type="button" id="closeModal" class="px-6 py-3 text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all">Cancelar</button>
                            <button type="submit" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-xl hover:shadow-lg transition-all">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Modal moderno de Venta -->
            <div id="modalVenta" class="fixed inset-0 bg-indigo-900 bg-opacity-40 backdrop-blur-sm flex justify-center items-center hidden z-50">
                <div class="bg-white p-8 rounded-2xl w-full max-w-md mx-4 shadow-xl">
                    <h2 class="text-2xl font-bold text-indigo-900 mb-6">Vender Producto</h2>
                    <form class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-indigo-900 mb-2">Nombre</label>
                            <input type="text" id="ventaNombre" readonly class="w-full px-4 py-3 rounded-xl bg-indigo-50 border-2 border-indigo-100">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-indigo-900 mb-2">Descripción</label>
                            <input type="text" id="ventaDescripcion" readonly class="w-full px-4 py-3 rounded-xl bg-indigo-50 border-2 border-indigo-100">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-indigo-900 mb-2">Precio</label>
                            <input type="text" id="ventaPrecio" readonly class="w-full px-4 py-3 rounded-xl bg-indigo-50 border-2 border-indigo-100">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-indigo-900 mb-2">Cantidad</label>
                            <input type="number" id="ventaCantidad" class="w-full px-4 py-3 rounded-xl border-2 border-indigo-100 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Cantidad a vender">
                        </div>
                        <input type="hidden" id="ventaID">
                        <div class="flex justify-end gap-4 mt-8">
                            <button type="button" id="cerrarVenta" class="px-6 py-3 text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all">Cancelar</button>
                            <button type="submit" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-xl hover:shadow-lg transition-all">Confirmar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script>
        function cargarProductos() {
            $.ajax({
                url: '/proyecto/public/bd/get_productos.php', // Ajusta la ruta según tu proyecto
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    let contenido = '';
                    data.forEach(producto => {
                        contenido += `<tr class="text-center">
                    <td class='border px-4 py-2'>${producto.id}</td>
                    <td class='border px-4 py-2'>${producto.nombre}</td>
                    <td class='border px-4 py-2'>${producto.descripcion}</td>
                    <td class='border px-4 py-2'>$${producto.precio}</td>
                    <td class='border px-4 py-2'>${producto.stock}</td>
                    <td class='border px-4 py-2'>${producto.categoria}</td>
                    <td class="border px-4 py-2">
                        <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded" 
                        onclick="venderProducto(${producto.id})">Vender</button> </td>
                    <td class="border px-4 py-2"> 
                        <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded"
                        onclick="eliminarProducto(${producto.id})">Eliminar </button> </td>

                   
                </tr>`;
                    });
                    $('#productos').html(contenido);
                },
                error: function (error) {
                    console.error('Error al cargar productos:', error);
                }
            });
        }

        function venderProducto(id) {
            // Buscar el producto por ID en la tabla ya cargada
            $.ajax({
                url: '/proyecto/public/bd/get_producto_por_id.php', // Crea este PHP
                method: 'GET',
                data: {
                    id: id
                },
                dataType: 'json',
                success: function (producto) {
                    // Rellenar los campos del modal
                    $('#ventaID').val(producto.id);
                    $('#ventaNombre').val(producto.nombre);
                    $('#ventaDescripcion').val(producto.descripcion);
                    $('#ventaPrecio').val(producto.precio);
                    $('#ventaCantidad').val('');

                    // Mostrar el modal
                    $('#modalVenta').removeClass('hidden');
                },
                error: function () {
                    Swal.fire('Error', 'No se pudo cargar la información del producto', 'error');
                }
            });
        }

        $('#modalVenta form').submit(function (event) {
            event.preventDefault();

            const producto_id = $('#ventaID').val();
            const cantidad = $('#ventaCantidad').val();

            $.ajax({
                url: '/proyecto/public/bd/registrar_venta.php',
                method: 'POST',
                data: {
                    producto_id: producto_id,
                    cantidad: cantidad
                },
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Venta realizada con éxito',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            $('#modalVenta').addClass('hidden');
                            cargarProductos(); // Recargar stock
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error en la venta',
                            text: response.error
                        });
                    }
                },
                error: function (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo completar la venta.'
                    });
                }
            });
        });





        function eliminarProducto(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: 'Esta acción no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then(result => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/proyecto/public/bd/delete_producto.php',
                        method: 'POST',
                        data: {
                            id: id
                        },
                        dataType: 'json',
                        success: function (response) {
                            if (response.status === 'success') {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Producto eliminado',
                                    timer: 1500,
                                    showConfirmButton: false
                                });
                                cargarProductos(); // Recarga la lista de productos
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: response.message
                                });
                            }
                        },
                        error: function () {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'No se pudo conectar con el servidor.'
                            });
                        }
                    });
                }
            });
        }




        $(document).ready(() => {
            cargarProductos();
        });

        // Funcion para agrgar Productos
        function agregarProducto() {
            const nombre = $('#productName').val().trim();
            const descripcion = $('#descripcionProduct').val().trim();
            const precio = $('#productPrice').val();
            const stock = $('#productStock').val();
            const categoria = $('#CategoriaProduct').val().trim();

            if (!nombre || !precio || !stock || !categoria) {
                Swal.fire('Campos obligatorios', 'Por favor completa todos los campos requeridos', 'warning');
                return;
            }

            $.ajax({
                url: '/proyecto/public/bd/insert_producto.php',
                method: 'POST',
                data: {
                    nombre: nombre,
                    descripcion: descripcion,
                    precio: precio,
                    stock: stock,
                    categoria: categoria
                },
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Producto agregado',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        $('#myModal').addClass('hidden');
                        cargarProductos();
                        $('#myModal form')[0].reset();
                    } else {
                        Swal.fire('Error', response.error || 'No se pudo agregar el producto', 'error');
                    }
                },
                error: function () {
                    Swal.fire('Error', 'No se pudo conectar con el servidor', 'error');
                }
            });
        }


        // Asignar la función al botón de guardar del formulario
        $('#myModal button[type="submit"]').click(function (event) {
            event.preventDefault(); // Prevenir el comportamiento por defecto del formulario
            agregarProducto(); // Llamar la función para agregar el producto
        });



        function logout() {
            window.location.href = "/proyecto/public/bd/logout.php";
        }

        $(document).ready(function () {
            cargarProductos();
        });



        const openModalBtn = document.getElementById('openModal');
        const modal = document.getElementById('myModal');
        const closeModalBtn = document.getElementById('closeModal');

        // Mostrar modal
        openModalBtn.addEventListener('click', () => {
            modal.classList.remove('hidden');
        });

        // Cerrar modal
        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        $('#cerrarVenta').click(function () {
            $('#modalVenta').addClass('hidden');
        });
    </script>

</html>