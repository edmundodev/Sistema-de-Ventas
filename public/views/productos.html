<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <div class="flex">
        <aside class="flex flex-col w-64 h-screen px-5 py-8 bg-white border-r dark:border-gray-700">
            <a href="#">
                <img class="w-auto h-7" src="https://merakiui.com/images/logo.svg" alt="Logo">
            </a>
            <div class="flex flex-col justify-between flex-1 mt-6">
                <nav class="space-y-6">
                    <div class="space-y-3">
                        <label class="px-3 text-xs text-gray-500 uppercase">Analytics</label>
                        <a class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-100" href="#">
                            <span class="mx-2 text-sm font-medium">Productos</span>
                        </a>
                    </div>
                    <div class="space-y-3">
                        <label class="px-3 text-xs text-gray-500 uppercase">Content</label>
                        <a class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-100" href="#">
                            <span class="mx-2 text-sm font-medium">Usuarios</span>
                        </a>
                    </div>
                    <div class="space-y-3">
                        <label class="px-3 text-xs text-gray-500 uppercase">Customization</label>
                        <a class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-100" href="#">
                            <span class="mx-2 text-sm font-medium">Nuevos Productos</span>
                        </a>
                        <a class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-100" href="#">
                            <span class="mx-2 text-sm font-medium">Configuración</span>
                        </a>
                        <a class="flex items-center px-3 py-2 text-gray-600 hover:bg-gray-100" href="#"
                            onclick="logout()">
                            <span class="mx-2 text-sm font-medium">Cerrar sesión</span>
                        </a>
                    </div>
                </nav>
            </div>
        </aside>
        <main class="flex-1 p-6">
            <h1 class="text-2xl font-bold">Lista de Productos</h1>
            <div class="flex justify-end">
                <button id="openModal"
                    class="flex items-center gap-2 bg-transparent hover:bg-blue-500 text-blue-700 font-semibold hover:text-white py-2 px-4 border border-blue-500 hover:border-transparent rounded transition-all duration-300">
                    <i class="fa-solid fa-plus fa-bounce"></i>
                    <span>Agregar producto</span>
                </button>
            </div>
            <br>
            <!-- Search Bar -->
            <div class="mb-6">
                <div class="relative">
                    <input type="text" placeholder="Buscar producto..."
                        class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-gray-500"></i>
                </div>
                <div class="mt-2 bg-white rounded-lg shadow-md hidden" id="searchResults">
                    <!-- Aquí se listarán productos encontrados -->
                </div>
            </div>
            <!-- Modal para agregar producto -->
            <div id="myModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center hidden">
                <div class="bg-white p-6 rounded-lg w-1/3">
                    <h2 class="text-xl font-semibold mb-4">Agregar Producto</h2>
                    <!-- Formulario o contenido del modal -->
                    <form>
                        <label for="productName" class="block text-sm font-medium text-gray-700">Nombre del
                            producto</label>
                        <input type="text" id="productName"
                            class="mt-1 p-2 border border-gray-300 rounded w-full mb-4 cursor-default focus:outline-none focus:ring-0"
                            placeholder="Nombre del producto">

                        <label for="descripcionProduct"
                            class="block text-sm font-medium text-gray-700">Descripcion</label>
                        <input type="text" id="descripcionProduct"
                            class="mt-1 p-2 border border-gray-300 rounded w-full mb-4 cursor-default focus:outline-none focus:ring-0"
                            placeholder="Descripcion del producto">

                        <label for="productPrice" class="block text-sm font-medium text-gray-700">Precio</label>
                        <input type="text" id="productPrice"
                            class="mt-1 p-2 border border-gray-300 rounded w-full mb-4 cursor-default focus:outline-none focus:ring-0"
                            placeholder="Precio del producto">

                        <label for="productStock" class="block text-sm font-medium text-gray-700">Stock</label>
                        <input type="text" id="productStock"
                            class="mt-1 p-2 border border-gray-300 rounded w-full mb-4 cursor-default focus:outline-none focus:ring-0"
                            placeholder="Stock del producto">

                        <label for="CategoriaProduct" class="block text-sm font-medium text-gray-700">Categoria</label>
                        <input type="text" id="CategoriaProduct"
                            class="mt-1 p-2 border border-gray-300 rounded w-full mb-4 cursor-default focus:outline-none focus:ring-0"
                            placeholder="Categoria del producto">

                        <div class="flex justify-end gap-4">
                            <button type="button" id="closeModal"
                                class="bg-red-500 text-white py-2 px-4 rounded">Cerrar</button>
                            <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded">Guardar</button>
                        </div>
                    </form>

                </div>
            </div>



            <!-- Modal para Vender Producto -->
            <!-- Modal para Vender Producto -->
            <div id="modalVenta"
                class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center hidden">
                <div class="bg-white p-6 rounded-lg w-1/3">
                    <h2 class="text-xl font-semibold mb-4">Vender Producto</h2>
                    <form>
                        <label for="ventaNombre" class="block text-sm font-medium text-gray-700">Nombre del
                            producto</label>
                        <input type="text" id="ventaNombre" readonly
                            class="mt-1 p-2 border border-gray-300 rounded w-full mb-4 cursor-not-allowed bg-gray-100">

                        <label for="ventaDescripcion"
                            class="block text-sm font-medium text-gray-700">Descripción</label>
                        <input type="text" id="ventaDescripcion" readonly
                            class="mt-1 p-2 border border-gray-300 rounded w-full mb-4 cursor-not-allowed bg-gray-100">

                        <label for="ventaPrecio" class="block text-sm font-medium text-gray-700">Precio</label>
                        <input type="text" id="ventaPrecio" readonly
                            class="mt-1 p-2 border border-gray-300 rounded w-full mb-4 cursor-not-allowed bg-gray-100">

                        <label for="ventaCantidad" class="block text-sm font-medium text-gray-700">Cantidad a
                            vender</label>
                        <input type="number" id="ventaCantidad"
                            class="mt-1 p-2 border border-gray-300 rounded w-full mb-4" placeholder="Cantidad">

                        <input type="hidden" id="ventaID"> <!-- ID oculto -->

                        <div class="flex justify-end gap-4">
                            <button type="button" id="cerrarVenta"
                                class="bg-red-500 text-white py-2 px-4 rounded">Cancelar</button>
                            <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded">Confirmar
                                Venta</button>
                        </div>
                    </form>
                </div>
            </div>


            <table class="w-full mt-4 border border-gray-300">
                <thead>
                    <tr class="bg-gray-200 text-center">
                        <th class="border px-4 py-2">ID</th>
                        <th class="border px-4 py-2">Nombre</th>
                        <th class="border px-4 py-2">Descripcion</th>
                        <th class="border px-4 py-2">Precio</th>
                        <th class="border px-4 py-2">Stock</th>
                        <th class="border px-4 py-2">Categoria</th>
                        <th class="border px-4 py-2">Vender</th>
                        <th class="border px-4 py-2">Elinimar</th>
                    </tr>
                </thead>
                <tbody id="productos"></tbody>
            </table>
        </main>
    </div>
    <script>
        function cargarProductos() {
            $.ajax({
                url: '/proyecto/public/bd/get_productos.php', // Ajusta la ruta según tu proyecto
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    let contenido = '';
                    data.forEach(producto => {
                        contenido += `<tr class="text-center">
                    <td class='border px-4 py-2'>${producto.id}</td>
                    <td class='border px-4 py-2'>${producto.nombre}</td>
                    <td class='border px-4 py-2'>${producto.descripcion}</td>
                    <td class='border px-4 py-2'>$${producto.precio}</td>
                    <td class='border px-4 py-2'>${producto.stock}</td>
                    <td class='border px-4 py-2'>${producto.categoria}</td>
                    <td class="border px-4 py-2">
                        <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded" 
                        onclick="venderProducto(${producto.id})">Vender</button> </td>
                    <td class="border px-4 py-2"> 
                        <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded"
                        onclick="eliminarProducto(${producto.id})">Eliminar </button> </td>

                   
                </tr>`;
                    });
                    $('#productos').html(contenido);
                },
                error: function (error) {
                    console.error('Error al cargar productos:', error);
                }
            });
        }

        function venderProducto(id) {
            // Buscar el producto por ID en la tabla ya cargada
            $.ajax({
                url: '/proyecto/public/bd/get_producto_por_id.php', // Crea este PHP
                method: 'GET',
                data: {
                    id: id
                },
                dataType: 'json',
                success: function (producto) {
                    // Rellenar los campos del modal
                    $('#ventaID').val(producto.id);
                    $('#ventaNombre').val(producto.nombre);
                    $('#ventaDescripcion').val(producto.descripcion);
                    $('#ventaPrecio').val(producto.precio);
                    $('#ventaCantidad').val('');

                    // Mostrar el modal
                    $('#modalVenta').removeClass('hidden');
                },
                error: function () {
                    Swal.fire('Error', 'No se pudo cargar la información del producto', 'error');
                }
            });
        }

        $('#modalVenta form').submit(function (event) {
            event.preventDefault();

            const producto_id = $('#ventaID').val();
            const cantidad = $('#ventaCantidad').val();

            $.ajax({
                url: '/proyecto/public/bd/registrar_venta.php',
                method: 'POST',
                data: {
                    producto_id: producto_id,
                    cantidad: cantidad
                },
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Venta realizada con éxito',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            $('#modalVenta').addClass('hidden');
                            cargarProductos(); // Recargar stock
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error en la venta',
                            text: response.error
                        });
                    }
                },
                error: function (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo completar la venta.'
                    });
                }
            });
        });




        function eliminarProducto(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: 'Esta acción no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then(result => {
                if (result.isConfirmed) {
                    // Aquí va la lógica AJAX para eliminar el producto
                    console.log("Eliminar producto con ID:", id);
                }
            });
        }

        $(document).ready(() => {
            cargarProductos();
        });

        // Funcion para agrgar Productos
        function agregarProducto() {
            // Obtener los valores del formulario
            const nombre = $('#productName').val();
            const descripcion = $('#descripcionProduct').val();
            const precio = $('#productPrice').val();
            const stock = $('#productStock').val();
            const categoria = $('#CategoriaProduct').val(); // Asegúrate de que haya un input o select para la categoría

            // Crear un objeto FormData para enviar los datos del formulario
            let formData = new FormData();
            formData.append('nombre', nombre);
            formData.append('descripcion', descripcion);
            formData.append('precio', precio);
            formData.append('stock', stock);
            formData.append('categoria', categoria);

            $.ajax({
                url: '/proyecto/public/bd/agregar_producto.php', // Ruta del backend PHP
                type: 'POST',
                data: formData,
                contentType: false, // Esto le dice a jQuery que no debe establecer el Content-Type
                processData: false, // Esto evita que jQuery procese los datos
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Producto agregado exitosamente',
                            showConfirmButton: false,
                            timer: 1500 // La alerta desaparecerá después de 1.5 segundos
                        }).then(() => {
                            cargarProductos(); // Recargar los productos
                            $('#myModal').hide(); // Cerrar el modal
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error al agregar producto',
                            text: response.error,
                        });
                    }
                },
                error: function (error) {
                    console.error('Error al agregar producto:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Hubo un error al agregar el producto',
                        text: 'Por favor, inténtalo de nuevo',
                    });
                }
            });
        }

        // Asignar la función al botón de guardar del formulario
        $('#myModal button[type="submit"]').click(function (event) {
            event.preventDefault(); // Prevenir el comportamiento por defecto del formulario
            agregarProducto(); // Llamar la función para agregar el producto
        });



        function logout() {
            window.location.href = "/proyecto/public/bd/logout.php";
        }

        $(document).ready(function () {
            cargarProductos();
        });



        const openModalBtn = document.getElementById('openModal');
        const modal = document.getElementById('myModal');
        const closeModalBtn = document.getElementById('closeModal');

        // Mostrar modal
        openModalBtn.addEventListener('click', () => {
            modal.classList.remove('hidden');
        });

        // Cerrar modal
        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        $('#cerrarVenta').click(function () {
            $('#modalVenta').addClass('hidden');
        });
    </script>
</body>

</html>